name: Auto Update (with TV)

on:
  push:
    branches: [ "main" ]
    paths:
      - "data/**"
      - "scripts/**"
      - ".github/workflows/**"
  workflow_dispatch: {}

permissions:
  contents: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas

      - name: Fetch short-lived secrets from TV
        run: |
          python scripts/tv_fetch.py \
            --tv-url https://StegVerse-Labs/TV \
            --role free-dom/ci/auto-update \
            --aud stegverse-tv \
            --keys secure_submission_url,private_store_endpoint,osint/* \
            --out /tmp/tv.json

      - name: Mask values in logs (defensive)
        run: |
          if [ -f /tmp/tv.json ]; then
            for val in $(jq -r '.[]? // empty' /tmp/tv.json); do
              if [ -n "$val" ]; then
                echo "::add-mask::$val"
              fi
            done
          fi
          echo "TV values acquired. (Secrets masked.)"

      - name: Build Version Badge
        run: python scripts/make_version_badge.py

      - name: Build Freshness Badge
        run: python scripts/make_freshness_badge.py

      - name: Merge pending + validate
        run: |
          python scripts/import_pending.py
          python scripts/build_checklist.py
          python scripts/build_changelog.py
          python scripts/update_timeline.py

      - name: Commit artifacts (if changed)
        uses: EndBug/add-and-commit@v9
        with:
          add: |
            CHANGELOG.md
            CHECKLIST.md
            data/summary/**
            docs/badges/**
            data/master/**
            data/unverified/**
            data/archive/**
          message: "chore(auto-update): merge + rebuild + badges + validate"
          default_author: github_actions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup secret file
        if: always()
        run: rm -f /tmp/tv.json
